# DouyinLiveRecorder 使用指南 (强化版)

本文档基于 `DouyinLiveRecorder` v4.0.7 源码分析编写，旨在提供比官方文档更详细的配置说明和使用技巧。

## 1. 快速开始

### 1.1 环境准备
*   **Python**: 建议版本 >= 3.10。
*   **FFmpeg**: 必须安装并配置环境变量。程序启动时会检查 `ffmpeg` 是否可用，如果缺少会直接退出。
    *   **Windows**: 下载解压后，将 `bin` 目录添加到系统 PATH。
    *   **Linux**: `yum install ffmpeg` 或 `apt install ffmpeg`。
*   **Node.js**: 部分加密参数（如抖音的 `x-bogus`）计算依赖 Node.js 环境，请确保已安装。

### 1.2 运行方式
```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 修改配置文件 (首次运行会自动生成 config/config.ini)
# 编辑 config/URL_config.ini 添加直播间地址

# 3. 运行
python main.py
```

---

## 2. 配置文件详解 (`config/config.ini`)

程序启动时会自动读取此文件，若不存在则生成默认值。

### 2.1 [录制设置]

| 配置项 | 默认值 | 说明 |
| :--- | :--- | :--- |
| `language` | `zh_cn` | 语言设置，支持 `zh_cn` / `en`。 |
| `是否跳过代理检测` | `否` | 若为 `否`，启动时会尝试连接 Google 测试网络连通性。 |
| `直播保存路径` | (空) | 默认为项目根目录下的 `downloads` 文件夹。建议填写绝对路径。 |
| `保存文件夹是否以作者区分` | `是` | 开启后，会在保存路径下创建以主播名为名的子文件夹。 |
| `保存文件夹是否以时间区分` | `否` | 开启后，会在主播文件夹下再创建日期文件夹 (格式 `YYYY-MM-DD`)。 |
| `视频保存格式` | `ts` | 支持 `ts`, `mkv`, `flv`, `mp4`, `mp3音频`, `m4a音频`。<br>**注意**: `shopee` 和 `花椒直播` 强制使用 `flv`；`猫耳FM` 和 `Look直播` 强制仅录制音频。 |
| `原画` | `原画` | 全局默认画质。支持 `原画`, `蓝光`, `超清`, `高清`, `标清`, `流畅`。 |
| `是否使用代理ip` | `是` | 全局代理开关。 |
| `代理地址` | (空) | 格式如 `http://127.0.0.1:7890`。若 `使用代理录制的平台` 命中当前平台，将使用此代理。 |
| `同一时间访问网络的线程数` | `3` | 并发检测直播状态的线程数。 |
| `循环时间(秒)` | `300` | 每一轮检测的间隔时间。 |
| `分段录制是否开启` | `是` | 推荐开启，避免单个文件过大导致损坏或难以处理。 |
| `视频分段时间(秒)` | `1800` | 默认 30 分钟分一段。 |
| `录制完成后自动转为mp4格式` | `是` | 录制结束后（或分段完成后）自动调用 FFmpeg 转封装为 MP4。 |
| `mp4格式重新编码为h264` | `否` | 若为 `是`，使用 `libx264` 重新编码（慢但兼容性好）；若为 `否`，仅复制流（快）。 |
| `是否录制完成后执行自定义脚本` | `否` | **高级功能**，录制结束后调用外部脚本。详见后文“自定义脚本”。 |
| `使用代理录制的平台` | (列表) | 指定哪些平台必须走代理。默认为所有海外平台 (TikTok, Twitch, YouTube等)。 |

### 2.2 [推送配置]

支持多种推送渠道，可同时填多个，用逗号分隔。

| 渠道 | 配置项关键点 |
| :--- | :--- |
| **微信** | `微信推送接口链接` (支持 `息知` 等兼容接口) |
| **钉钉** | `钉钉推送接口链接`, `钉钉通知@对象` (手机号) |
| **TG** | `tgapi令牌`, `tg聊天id` |
| **邮箱** | 需配置 SMTP 服务器、账号、密码、收件人等。支持 SSL。 |
| **Bark** | iOS 推送，需填写 `bark推送接口链接`。 |
| **Ntfy** | `ntfy推送地址`, `ntfy推送标签`。 |

*   **自定义推送内容**: 支持变量替换。
    *   `[直播间名称]`: 替换为主播名。
    *   `[时间]`: 替换为当前时间。

### 2.3 [Cookie] & [Authorization] & [账号密码]
*   **抖音Cookie**: 必须填写 `ttwid`, `odin_tt`, `passport_csrf_token` 等字段，否则无法获取高清流或被风控。
*   **海外平台**: 如 `PopkonTV` 需要 `partner_code` 和 `token`；`SoopLive`, `FlexTV` 等支持账号密码自动登录获取 Cookie。

---

## 3. 直播间配置 (`config/URL_config.ini`)

### 3.1 基本格式
一行一个直播间，支持三种格式：
1.  **仅 URL**: 使用全局默认画质。
    ```text
    https://live.douyin.com/123456
    ```
2.  **画质 + URL**: 指定该直播间的画质。
    ```text
    超清,https://live.douyin.com/123456
    ```
3.  **画质 + URL + 主播名**: 强制指定主播名（覆盖自动获取的名称）。
    ```text
    原画,https://live.douyin.com/123456,我的女神
    ```

### 3.2 特殊用法
*   **注释**: 行首加 `#` 可临时跳过该直播间。
    ```text
    #原画,https://live.douyin.com/123456
    ```
*   **自定义直链**: 支持直接录制 `.m3u8` 或 `.flv` 地址。
    ```text
    http://example.com/stream.m3u8
    ```
    此时平台名称会被识别为 `自定义录制直播`。
*   **小红书**: 支持用户主页链接，程序会自动提取 `host_id`。

---

## 4. 高级功能：自定义脚本

当 `是否录制完成后执行自定义脚本 = 是` 时，程序会在录制结束（或分段完成）后执行 `自定义脚本执行命令` 中指定的脚本。

### 4.1 参数传递机制
程序会根据命令中是否包含 `python` 字符串来决定参数传递方式。

#### 情况 A: Python 脚本 (命令包含 `python`)
程序会以 `--key value` 的形式追加命名参数：
```bash
python my_script.py --record_name "主播名" --save_file_path "D:/video/xxx.ts" --save_type "TS" --split_video_by_time True --converts_to_mp4 False
```
**你的 Python 脚本应该使用 `argparse` 来解析这些参数。**

#### 情况 B: 其他脚本 (Shell/Batch)
程序会按固定顺序追加位置参数：
```bash
my_script.sh "主播名" "D:/video/xxx.ts" "TS" "split_video_by_time:True" "converts_to_mp4:False"
```
*   `$1`: 主播名 (去除前缀)
*   `$2`: 文件绝对路径
*   `$3`: 保存格式
*   `$4`: 分段标记 (格式 `key:value`)
*   `$5`: 转码标记 (格式 `key:value`)

### 4.2 使用场景示例
*   **自动上传**: 录制完成后调用 `rclone` 上传到网盘。
*   **消息通知**: 录制完成后发送包含文件大小的统计报告。
*   **后处理**: 调用 `ffmpeg` 进行复杂的压制或剪辑。

---

## 5. 常见问题 (FAQ)

**Q: 为什么抖音录制失败？**
A: 抖音风控严格，必须在 `config.ini` 中填写完整的 `抖音cookie`。建议从浏览器开发者工具中复制完整的 Cookie 字符串。

**Q: 如何获取淘宝/抖音等平台的 Cookie？**
A: 
1. 电脑浏览器打开对应平台的直播网页（如 `https://live.taobao.com/`），并登录账号。
2. 按 `F12` 打开开发者工具，切换到 `Network` (网络) 标签页。
3. 刷新页面 (`F5`)。
4. 在左侧请求列表中找到主页请求（通常是第一个）或任意 API 请求。
5. 在右侧 `Headers` (标头) -> `Request Headers` (请求头) 中找到 `Cookie`。
6. 复制 `Cookie: ` 冒号后面的所有内容，粘贴到配置文件对应位置。
   *   **注意**: 淘宝需要重点关注是否包含 `_m_h5_tk` 字段，这是签名计算的关键。

**Q: 如何录制海外直播（如 TikTok）？**
A: 
1. 确保电脑已开启代理软件。
2. 在 `config.ini` 中设置 `是否使用代理ip = 是`。
3. 填写正确的 `代理地址` (例如 `http://127.0.0.1:7890`)。

**Q: 录制的视频只有声音没有画面？**
A: 部分平台（如猫耳FM）是纯音频直播。另外，请检查是否在配置文件中误选了 `MP3` 或 `M4A` 格式。

**Q: 如何停止录制？**
A: 
*   **交互式**: 在终端按 `Ctrl + C`。
*   **脚本**: 运行项目目录下的 `StopRecording.vbs` (仅 Windows)。
*   **配置**: 在 `URL_config.ini` 中对应的 URL 前加 `#`，程序会在下一次轮询时自动停止该任务。

**Q: 为什么生成的 MP4 无法在某些播放器播放？**
A: 默认的 MP4 转码是 `copy` 模式（不重新编码）。如果源流的编码格式特殊，可能导致兼容性问题。尝试将 `mp4格式重新编码为h264` 设置为 `是`。
